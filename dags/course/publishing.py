"""
Publishing artifacts consist of:
1. Slide_Generated
2. Video
3. Assessment
4. Chatbot
5. Quiz Certificate -> temporary needs to be created
6. Home Page Introduction
7. App image
8. Artifacts Linked
9. slides_links
10. video_links
11. Module Names
12. Module Introductions


1. How to display additional artifacts like the labs, podcasts and the writing resources?
2. iterative addition and publishing
"""

{"_id":"67094967b06a9ba0559cbb7e","app_name":"QU AI Fall School: Use and Governance of Generative AI at Large US Financial Institutions","app_image_location":"https://qucoursify.s3.amazonaws.com/QU-AI-Fall-School-2024/Guest-Lecture-2/title-page.png","home_page_introduction":"# Introduction","short_description":"The QU AI Fall School Lecture 2, part of the 2024 series, features Jacob Kosoff from Bank of America. Jacob Kosoff is a leading expert in data science and model development, with extensive experience in financial institutions. His expertise in generative AI positions him well to discuss its role in modern finance.","document_link":"","certificate_path":"","slides_links":[""],"course_names_videos":[""],"course_module_information":[""],"course_names_slides":[],"videos_links":[""],"has_chatbot":false,"has_quiz":false,"__v":{"$numberInt":"0"},"external_link":"https://academy.qusandbox.com/market/670598c150c75511c728b53b"}
{"_id":"66f1af7741d4a2428f79ff51","app_code":"AAVIA","app_image_location":"https://qucoursify.s3.us-east-1.amazonaws.com/qu-aavia/course-image.png","app_name":"Army Aviation's Role in Unified Land Operations","home_page_introduction":"## Introduction\n\nArmy Aviation is a vital component of Unified Land Operations, seamlessly bridging air and ground capabilities to achieve strategic objectives in dynamic and complex environments. This course provides a comprehensive overview of Army Aviation's role, emphasizing its core competencies, integration into operations, and adaptability within diverse operational environments. Designed for both newcomers and experienced professionals, this course will enhance your understanding of Army Aviation's pivotal contributions to mission success.\n\n## Course Overview\n\nThis course is divided into four modules, each focusing on a critical aspect of Army Aviation within Unified Land Operations:\n\n1. **Module 1: Introduction**  \n   Gain a foundational understanding of Army Aviation's mission, history, and significance in modern military operations.\n\n2. **Module 2: Core Competencies of Army Aviation**  \n   Explore the essential skills and capabilities that define Army Aviation, including mobility, reconnaissance, and close combat support.\n\n3. **Module 3: Army Operations in the Aviation Framework**  \n   Understand how Army Aviation integrates into operational planning and execution, supporting ground forces across a wide range of missions.\n\n4. **Module 4: Operational Environment**  \n   Examine the challenges and dynamics of the modern operational environment, focusing on how Army Aviation adapts to diverse and evolving threats.\n\nBy completing this course, you will gain a holistic understanding of Army Aviation's strategic and operational roles, preparing you to effectively apply this knowledge in military contexts.\n\n\n\n\n### Reference:\n[FM 1-100: \"Army Aviation Operations\" (PDF). Headquarters, Department of the Army. 21 February 1997. Archived from the original (PDF) on 30 January 2023.](https://web.archive.org/web/20230317152129/https://irp.fas.org/doddir/army/fm3-04.pdf)","short_description":"Army Aviation's Role in Unified Land Operations explores how aviation integrates with ground forces to achieve mission success. This course provides insights into its tactical, operational, and future innovations.","document_link":"https://web.archive.org/web/20230317152129/https://irp.fas.org/doddir/army/fm3-04.pdf","retriever_db_path":"","hybrid_db_path":"","questions_file":"","certificate_path":"","chatbot_location":"","slides_links":["https://qucoursify.s3.us-east-1.amazonaws.com/qu-aavia/slides/SECTION+I++OVERVIEW.pdf","https://qucoursify.s3.us-east-1.amazonaws.com/qu-aavia/slides/SECTION+II++CORE+COMPETENCIES+OF+ARMY+AVIATION.pdf","https://qucoursify.s3.us-east-1.amazonaws.com/qu-aavia/slides/SECTION+III++ARMY+AVIATION+IN+THE+OPERATIONAL+FRAMEWORK.pdf","https://qucoursify.s3.us-east-1.amazonaws.com/qu-aavia/slides/SECTION+IV++OPERATIONAL+ENVIRONMENT.pdf"],"course_names_videos":["Introduction","Core Competencies of Army Aviation","Integration of Aviation with Ground Forces","Operational Environment"],"course_module_information":["In this module, you'll gain a foundational understanding of Army Aviation's history, mission, and evolution. This includes its origins, development as a key operational component, and its unique contributions to modern warfare. By the end of this module, you'll have a solid grasp of the overarching framework and significance of Army Aviation.\n\n### Key Topics:\n- Historical development of Army Aviation  \n- The mission and strategic importance of Army Aviation  \n- Current roles and responsibilities within Unified Land Operations  \n\n### Reference:\n[FM 1-100: \"Army Aviation Operations\" (PDF). Headquarters, Department of the Army. 21 February 1997. Archived from the original (PDF) on 30 January 2023.](https://web.archive.org/web/20230317152129/https://irp.fas.org/doddir/army/fm3-04.pdf)","This module focuses on the essential skills and capabilities that form the backbone of Army Aviation operations. You'll explore topics such as aerial reconnaissance, troop transport, close combat support, and sustainment operations. This module highlights how these core competencies ensure mission success across various operational contexts.\n\n### Key Topics:\n- Aerial reconnaissance and surveillance  \n- Air mobility and troop transport  \n- Close combat attack and support roles  \n- Logistics and sustainment through aviation  \n\n### Reference:\n[FM 1-100: \"Army Aviation Operations\" (PDF). Headquarters, Department of the Army. 21 February 1997. Archived from the original (PDF) on 30 January 2023.](https://web.archive.org/web/20230317152129/https://irp.fas.org/doddir/army/fm3-04.pdf)","This module examines how Army Aviation integrates into broader operational frameworks, supporting ground forces and enhancing mission effectiveness. You'll learn about joint planning, coordination, and execution of missions where aviation and ground elements work in unison.\n\n### Key Topics:\n- Joint planning and coordination with ground forces  \n- Aviation's role in offensive, defensive, and stability operations  \n- Case studies of successful integration in past operations  \n\n### Reference:\n[FM 1-100: \"Army Aviation Operations\" (PDF). Headquarters, Department of the Army. 21 February 1997. Archived from the original (PDF) on 30 January 2023.](https://web.archive.org/web/20230317152129/https://irp.fas.org/doddir/army/fm3-04.pdf)","In this module, you'll explore the dynamic and evolving operational environments in which Army Aviation operates. Topics include adapting to diverse terrains, weather conditions, and emerging threats. You'll also delve into the challenges posed by adversaries and the importance of situational awareness in complex environments.\n\n### Key Topics:\n- Adapting to diverse terrains and climates  \n- Countering emerging threats and adversary tactics  \n- Understanding situational awareness and decision-making in real-time operations  \n\n### Reference:\n[FM 1-100: \"Army Aviation Operations\" (PDF). Headquarters, Department of the Army. 21 February 1997. Archived from the original (PDF) on 30 January 2023.](https://web.archive.org/web/20230317152129/https://irp.fas.org/doddir/army/fm3-04.pdf)"],"course_names_slides":["Introduction","Core Competencies of Army Aviation","Integration of Aviation with Ground Forces","Operational Environment"],"videos_links":["<div style='padding:56.25% 0 0 0;position:relative;'><iframe src='https://player.vimeo.com/video/1031959165?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479' frameborder='0' allow='autoplay; fullscreen; picture-in-picture; clipboard-write' style='position:absolute;top:0;left:0;width:100%;height:100%;' title='SECTION I  OVERVIEW'></iframe></div><script src='https://player.vimeo.com/api/player.js'></script>","<div style='padding:56.25% 0 0 0;position:relative;'><iframe src='https://player.vimeo.com/video/1031959175?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479' frameborder='0' allow='autoplay; fullscreen; picture-in-picture; clipboard-write' style='position:absolute;top:0;left:0;width:100%;height:100%;' title='SECTION II  CORE COMPETENCIES OF ARMY AVIATION'></iframe></div><script src='https://player.vimeo.com/api/player.js'></script>","<div style='padding:56.25% 0 0 0;position:relative;'><iframe src='https://player.vimeo.com/video/1031959211?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479' frameborder='0' allow='autoplay; fullscreen; picture-in-picture; clipboard-write' style='position:absolute;top:0;left:0;width:100%;height:100%;' title='SECTION III  ARMY AVIATION IN THE OPERATIONAL FRAMEWORK'></iframe></div><script src='https://player.vimeo.com/api/player.js'></script>","<div style='padding:56.25% 0 0 0;position:relative;'><iframe src='https://player.vimeo.com/video/1031959229?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479' frameborder='0' allow='autoplay; fullscreen; picture-in-picture; clipboard-write' style='position:absolute;top:0;left:0;width:100%;height:100%;' title='SECTION IV  OPERATIONAL ENVIRONMENT'></iframe></div><script src='https://player.vimeo.com/api/player.js'></script>"],"contact_form_link":"https://docs.google.com/forms/d/e/1FAIpQLSfWkOK-in_bMMoHSZfcIvAeO58PAH9wrDqcxnJABHaxiDqhSA/viewform?usp=sf_link","has_chatbot":false,"has_quiz":false,"disclaimer":""}

course_object = {
    "app_name": "",
    "course_id": "",
    "app_code": "",
    "app_image_location": "",
    "home_page_introduction": "",
    "short_description": "",
    "document_link": "",
    "certificate_path": "",
    "slides_links": [],
    "course_names_videos": [],
    "course_module_information": [],
    "course_names_slides": [],
    "videos_links": [],
    "module_ids": [],
    "has_chatbot": False,
    "has_quiz": False,
    "external_link": "",
    "contact_form_link": "",
    "disclaimer": "\nThis course contains content that has been partially or fully generated using artificial intelligence (AI) technology. While every effort has been made to ensure the accuracy and quality of the materials, please note that AI-generated content may not always reflect the latest developments, best practices, or personalized nuances within the field. We encourage you to critically evaluate the information presented and consult additional resources where necessary.\n"
}


"""
# Only courses will be able to be published
1. Get the course if it is already published
2. Get the modules ready for publishing from the queue. Do not delete them from the queue. 
3. Get the artifacts for publishing the modules.
4. append the artifacts to the appropriate fields
5. update Mongodb with the changes.
"""

from utils.mongodb_client import AtlasClient
from bson import ObjectId
import logging


def handle_update_course(course_id):
    """
    Steps:
    1. Get the course object from courses
    2. Get the course design from the courses_design.
    3. Get the modules ready for publishing from the publishing queue.
    4. For all the modules in the publishing queue, update the course objects.
    5. Update the course object in the courses collection.
    6. Update the course design with the status for the published courses in the course_design collection.
    """
    try:
        mongo_client = AtlasClient()
        course = mongo_client.find("courses", filter={"course_id": ObjectId(course_id)})
        if not course:
            return "Course not found"
        
        course = course[0]

        course_design = mongo_client.find("course_design", filter={"_id": ObjectId(course_id)})
        if not course_design:
            return "Course design not found"
        
        course_design = course_design[0]

        modules = mongo_client.find("publishing_queue", filter={"course_id": ObjectId(course_id)})

        slide_links = []
        slide_names = []
        video_links = []
        module_ids = []
        course_module_information = []

        for module in modules:
            module_id = module["module_id"]
            module_ids.append(module_id)
            module_obj = next((m for m in course_design.get("modules", []) if m.get("module_id") == ObjectId(module_id)), None)
            slide_names.append(module_obj["module_name"])

            for resource in module_obj['post_processed_deliverables']:
                if resource['resource_type'] == "Slide_Generated":
                    slide_link = resource['resource_link']
                    slide_links.append(slide_link)
                elif resource['resource_type'] == "Video":
                    video_link = resource['resource_link']
                    video_links.append(video_link)
                elif resource['resource_type'] == "Note":
                    notes_link = resource['resource_link']
                    with open(notes_link, "r") as f:
                        course_module_information.append(f.read())
        
        course["slides_links"] = slide_links
        course["course_names_slides"] = slide_names
        course["videos_links"] = video_links
        course["module_ids"] = module_ids
        course["course_module_information"] = course_module_information
        course["course_names_videos"] = slide_names

        mongo_client.update("courses", filter={"course_id": ObjectId(course_id)}, update=course)
        
        for module in modules:
            module_id = module["module_id"]
            for index, module_obj in enumerate(course_design.get("modules", [])):
                if module_obj.get("module_id") == ObjectId(module_id):
                    course_design["modules"][index]["status"] = "Published"
                    break
        
        
        mongo_client.update("course_design", filter={"_id": ObjectId(course_id)}, update=course_design)
        mongo_client.update("course_design", filter={"_id": ObjectId(course_id)}, update={"$set": {"status": "Published"}})


    except Exception as e:
        logging.error(f"Error in updating course: {e}")

    
def handle_create_course(course_id):
    """
    Steps: 
    Create a new course object
    Get the course from the course design
    Get the modules ready for publishing from the publishing queue
    For all the modules in the publishing queue, update the course objects
    Insert the course object in the courses collection
    Update the course design with the status for the published courses in the course_design collection

    """


def publish_course(course_id):
    mongo_client = AtlasClient()
    course = mongo_client.find("courses", filter={"course_id": ObjectId(course_id)})
    if not course:
        handle_update_course(course_id)
    else:
        handle_create_course(course_id)

    